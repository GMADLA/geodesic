#!/usr/bin/env variant
# vim:set ft=yaml



parameters:
- name: namespace
  default: "default"
  description: "Kubernetes namespace"

- name: version
  default: "1.1.4"
  description: "Istio version"

- name: repo
  default: "https://github.com/istio/istio"
  description: "Istio repo"

tasks:

  # https://istio.io/docs/tasks/traffic-management/ingress/#determining-the-ingress-ip-and-ports-when-using-an-external-load-balancer
  ingress:
    description: Output the FQHN of the Istio Ingress Gateway
    script: |
      kubectl --namespace istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'

  # https://istio.io/docs/setup/kubernetes/quick-start/
  injection:
    description: Enable Istio Sidecar Injection for a namespace
    script: |
      kubectl label namespace {{ get "namespace" }} istio-injection=enabled --overwrite=true

  init:
    description: Install Istio helm chart
    script: |
      git clone --depth 1 --branch {{ get "version" }} {{ get "repo" }}
      helm install istio/install/kubernetes/helm/istio-init --name istio-init --namespace istio-system \
        --set global.hub="docker.io/istio" \
        --set global.tag={{ get "version" }} \
        --set certmanager.enabled=true
